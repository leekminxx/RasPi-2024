from PyQt5.QtWidgets import *
from PyQt5 import uic
from PyQt5.QtCore import QTimer, QThread, pyqtSignal
from PyQt5.QtGui import QColor
import sys
import RPi.GPIO as GPIO
import time
import adafruit_dht
import board

# GPIO 설정
red = 25
green = 19
blue = 26
piezoPin = 4
trigPin = 27
echoPin = 17
sensor_pin = 20

GPIO.setwarnings(False)
GPIO.setmode(GPIO.BCM)
GPIO.setup(red, GPIO.OUT)
GPIO.setup(green, GPIO.OUT)
GPIO.setup(blue, GPIO.OUT)
GPIO.setup(piezoPin, GPIO.OUT)
GPIO.setup(trigPin, GPIO.OUT)
GPIO.setup(echoPin, GPIO.IN)
GPIO.setup(sensor_pin, GPIO.IN)

dhtDevice = adafruit_dht.DHT11(board.D18)  # DHT11 센서 초기화
# PWM 설정
pwm_red = GPIO.PWM(red, 100)  # Red LED, 100 Hz
pwm_green = GPIO.PWM(green, 100)  # Green LED, 100 Hz
pwm_blue = GPIO.PWM(blue, 100)  # Blue LED, 100 Hz
pwm_piezo = GPIO.PWM(piezoPin, 1000)  # Piezo Buzzer, 1000 Hz

form_class = uic.loadUiType("led.ui")[0]

class UltrasonicThread(QThread):
    distance_measured = pyqtSignal(float)

    def __init__(self):
        super().__init__()

    def run(self):
        while True:
            GPIO.output(trigPin, GPIO.HIGH)
            time.sleep(0.00001)
            GPIO.output(trigPin, GPIO.LOW)

            while GPIO.input(echoPin) == GPIO.LOW:
                pulse_start = time.time()

            while GPIO.input(echoPin) == GPIO.HIGH:
                pulse_end = time.time()

            pulse_duration = pulse_end - pulse_start
            distance = pulse_duration * 17150
            distance = round(distance, 2)

            self.distance_measured.emit(distance)
            time.sleep(1)

class DHTThread(QThread):
    temp_measured = pyqtSignal(float)
    humid_measured = pyqtSignal(float)

    def __init__(self):
        super().__init__()

    def run(self):
        while True:
            try:
                temp = dhtDevice.temperature
                humid = dhtDevice.humidity
                print(f'Temp: {temp}C / Humidity: {humid}%')
                self.temp_measured.emit(temp)
                self.humid_measured.emit(humid)
                time.sleep(2)
            except RuntimeError as error:
                print(f'Runtime error occurred: {error}')
                time.sleep(2)
            except Exception as error:
                print(f'Error occurred: {error}')
                time.sleep(2)

class WindowClass(QMainWindow, form_class):
    def __init__(self):
        super().__init__()
        self.setupUi(self)
        self.btn_2.clicked.connect(self.turnOffLED)
        self.btn1_r.clicked.connect(self.turnOnRed)
        self.btn1_g.clicked.connect(self.turnOnGreen)
        self.btn1_b.clicked.connect(self.turnOnBlue)
        self.btn_switch.clicked.connect(self.toggleCycling)
        self.btn_sound.clicked.connect(self.togglePiezo)
        
        self.dial_led.valueChanged.connect(self.dialValueChanged)
        self.dial_sound.valueChanged.connect(self.soundDialValueChanged)

        self.label_led.setText("0")
        self.label_sound.setText("0")

        self.timer = QTimer(self)
        self.timer.timeout.connect(self.cycleColors)
        self.cycling = False
        self.current_color_index = 0
        self.colors = [self.turnOnRed, self.turnOnGreen, self.turnOnBlue]

        self.ultrasonic_thread = UltrasonicThread()
        self.ultrasonic_thread.distance_measured.connect(self.handleDistance)
        self.ultrasonic_thread.start()

        self.dht_thread = DHTThread()
        self.dht_thread.temp_measured.connect(self
